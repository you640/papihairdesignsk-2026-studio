/**
 * @file Firestore Security Rules for PAPI Hair DESIGN Studio
 * @version 2
 *
 * @Core Philosophy:
 * This ruleset implements a hybrid security model. User data is strictly controlled via path-based ownership.
 * Public content (stylists, services, products, gallery items, loyalty rewards) is readable by all, but
 * modification is limited to administrators. Blog posts are publicly readable, but write access is restricted
 * to the author or an admin.  Admin privileges are determined by the existence of a document in the `roles_admin` collection.
 *
 * @Data Structure:
 * - /users/{userId}: User profile data.  Only accessible to the user themselves.
 * - /stylists/{stylistId}, /services/{serviceId}, /products/{productId}, /galleryItems/{galleryItemId}, /loyaltyRewards/{rewardId}:
 *   Publicly readable data, only writable by admins.
 * - /blogPosts/{blogPostId}: Publicly readable, writable by the author or admins.
 * - /appointments/{appointmentId}: Appointments, accessible to admins and the associated user.
 * - /users/{userId}/appointments/{appointmentId}: User-specific appointments, only accessible to the user.
 * - /adminNotifications/{notificationId}: Notifications for admins, only accessible to admins.
 * - /config/{configId}: Configuration settings, only accessible to admins.
 * - /roles_admin/{userId}: Defines admin roles. The existence of a document implies admin rights.
 *
 * @Key Security Decisions:
 * - Admin role is determined by the presence of a document in the `/roles_admin/{userId}` collection.
 * - Publicly readable collections (`stylists`, `services`, `products`, `galleryItems`, `loyaltyRewards`) allow open reads (`get`, `list`).
 * - User listing is generally disallowed for privacy except for admin role assignment collection to improve admin management.
 * - The `Config` collection is strictly admin-only.
 *
 * @Denormalization for Authorization:
 * - The `User` documents DO NOT contain an `isAdmin` field. Instead, admin status is checked by looking for the existence of a document `/roles_admin/{userId}`.
 * - The `BlogPost` documents MUST contain the `authorId` to enforce write access.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     * @example isSignedIn() == true
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document based on the userId.
     * @param {string} userId - The user ID to check against.
     * @return {bool} True if the user is the owner, false otherwise.
     * @example isOwner('someUserId') == true
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is an existing owner of the document.
     *              This function combines the ownership check with a resource existence check
     *              to prevent operations on non-existent documents.
     * @param {string} userId - The user ID to check against.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     * @example isExistingOwner('someUserId') == true
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user is an admin by verifying the existence of a document in the /roles_admin/{userId} collection.
     * @return {bool} True if the user is an admin, false otherwise.
     * @example isAdmin() == true
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Defines the base path for all user-related documents.
     * @path /users/{userId}
     * @allow (create) User 'user123' can create their profile if request.auth.uid == 'user123'.
     * @deny (create) User 'user456' cannot create profile for 'user123' if request.auth.uid != 'user123'.
     * @allow (get, update, delete) User 'user123' can read/update/delete their own profile.
     * @deny (get, update, delete) User 'user456' cannot read/update/delete 'user123' profile.
     * @principle Enforces document ownership for user profiles; only the authenticated user can manage their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is generally disallowed for privacy.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines the path for all stylist profile documents.
     * @path /stylists/{stylistId}
     * @allow (get, list) Any user can read stylist profiles.
     * @allow (create, update, delete) Only admins can modify stylist profiles.
     * @deny (create, update, delete) Non-admin users cannot modify stylist profiles.
     * @principle Public read access with admin-only writes.
     */
    match /stylists/{stylistId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Defines the path for all service documents.
     * @path /services/{serviceId}
     * @allow (get, list) Any user can read service details.
     * @allow (create, update, delete) Only admins can modify service details.
     * @deny (create, update, delete) Non-admin users cannot modify service details.
     * @principle Public read access with admin-only writes.
     */
    match /services/{serviceId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Defines the path for all product documents.
     * @path /products/{productId}
     * @allow (get, list) Any user can read product information.
     * @allow (create, update, delete) Only admins can modify product information.
     * @deny (create, update, delete) Non-admin users cannot modify product information.
     * @principle Public read access with admin-only writes.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Defines the path for all gallery item documents.
     * @path /galleryItems/{galleryItemId}
     * @allow (get, list) Any user can read gallery images.
     * @allow (create, update, delete) Only admins can modify gallery items.
     * @deny (create, update, delete) Non-admin users cannot modify gallery items.
     * @principle Public read access with admin-only writes.
     */
    match /galleryItems/{galleryItemId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Defines the path for all blog post documents.
     * @path /blogPosts/{blogPostId}
     * @allow (get, list) Any user can read blog posts.
     * @allow (create) Only admins or the author can create blog posts. The authorId must match the authenticated user.
     * @allow (update, delete) Only admins or the author can modify/delete blog posts.
     * @deny (create) Non-admin users cannot create blog posts with mismatched authorId.
     * @deny (update, delete) Non-admin users cannot modify blog posts they don't own.
     * @principle Public read access with author/admin-controlled writes.
     */
    match /blogPosts/{blogPostId} {
      allow get, list: if true;
      allow create: if isSignedIn() && (isAdmin() || request.resource.data.authorId == request.auth.uid);
      allow update, delete: if isSignedIn() && (isAdmin() || (resource != null && resource.data.authorId == request.auth.uid));
    }

    /**
     * @description Defines the path for all appointment documents.
     * @path /appointments/{appointmentId}
     * @allow (get, list) Only admins or the associated user can access appointments.
     * @allow (create, update, delete) Only admins can modify appointments.
     * @deny (get, list) Non-admin users cannot access appointments that are not associated with them.
     * @principle Access is restricted to admins and the associated user.
     */
    match /appointments/{appointmentId} {
      allow get: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow list: if isAdmin();
      allow create: if isSignedIn() && (isAdmin() || request.resource.data.userId == request.auth.uid);
      allow update, delete: if isSignedIn() && (isAdmin() || (resource != null && resource.data.userId == request.auth.uid));
    }
    
    /**
     * @description Defines the path for user-specific appointment subcollections.
     * @path /users/{userId}/appointments/{appointmentId}
     */
    match /users/{userId}/appointments/{appointmentId} {
      allow read, write: if isOwner(userId);
    }
    
    /**
     * @description Defines the path for all order documents.
     * @path /orders/{orderId}
     */
    match /orders/{orderId} {
        allow read: if isSignedIn() && (isAdmin() || resource.data.userId == request.auth.uid);
        allow list: if isAdmin();
        allow create: if isSignedIn();
        allow update: if isAdmin();
        allow delete: if false;
    }


    /**
     * @description Defines the path for all admin notification documents.
     * @path /adminNotifications/{notificationId}
     * @allow (get, list, create, update, delete) Only admins can manage admin notifications.
     * @deny (get, list, create, update, delete) Non-admin users cannot access admin notifications.
     * @principle Restricts access to admin notifications to administrators only.
     */
    match /adminNotifications/{notificationId} {
      allow get, list, write: if isAdmin();
    }

    /**
     * @description Defines the path for all loyalty reward documents.
     * @path /loyaltyRewards/{rewardId}
     * @allow (get, list) Any user can read loyalty reward definitions.
     * @allow (create, update, delete) Only admins can modify loyalty rewards.
     * @deny (create, update, delete) Non-admin users cannot modify loyalty rewards.
     * @principle Public read access with admin-only writes.
     */
    match /loyaltyRewards/{rewardId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Defines the path for all config documents.
     * @path /config/{configId}
     * @allow (get, list, create, update, delete) Only admins can manage configuration settings.
     * @deny (get, list, create, update, delete) Non-admin users cannot access configuration settings.
     * @principle Restricts access to configuration settings to administrators only.
     */
    match /config/{configId} {
      allow get, list, write: if isAdmin();
    }

   /**
    * @description Defines the path for assigning admin roles.
    * @path /roles_admin/{userId}
    * @allow (get, list) Only admins can read admin role assignments.
    * @allow (create, delete) Only admins can assign or revoke admin roles.
    * @deny (create, delete) Non-admin users cannot manage admin roles.
    * @principle Restricts admin role management to administrators only.
    */
    match /roles_admin/{userId} {
        allow get, list: if isAdmin();
        allow create, delete: if isAdmin();
        allow update: if false;
    }
  }
}
